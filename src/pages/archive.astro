---
import { getCollection } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_TITLE } from '../consts';

const posts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Helper: add ordinal suffix
function ordinal(n) {
  const s = ["th", "st", "nd", "rd"];
  const v = n % 100;
  return n + (s[(v - 20) % 10] || s[v] || s[0]);
}

// Group posts by year and month
const grouped = posts.reduce((acc, post) => {
  const date = new Date(post.data.pubDate);
  const year = date.getFullYear();
  const month = date.toLocaleString('default', { month: 'long' });

  if (!acc[year]) acc[year] = {};
  if (!acc[year][month]) acc[year][month] = [];
  acc[year][month].push(post);

  return acc;
}, {});
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={`Archive | ${SITE_TITLE}`} description="All blog posts by date" />
    <style>
      h2 { margin-left: 0; }
      h3 { margin-left: 1rem; }
      ul { margin-left: 2rem; list-style-type: none; padding: 0; }
      li { margin: 0.25rem 0; }
    </style>
  </head>
  <body>
    <Header />
    <main>
      {
        Object.keys(grouped)
          .sort((a, b) => b - a) // years descending
          .map((year) => (
            <section>
              <h2>{year}</h2>
              {
                Object.keys(grouped[year])
                  .sort((a, b) => {
                    const monthOrder = new Date(`${b} 1, ${year}`) - new Date(`${a} 1, ${year}`);
                    return monthOrder;
                  })
                  .map((month) => (
                    <div>
                      <h3>{month}</h3>
                      <ul>
                        {
                          grouped[year][month].map((post) => {
                            const date = new Date(post.data.pubDate);
                            const day = date.getDate();
                            return (
                              <li>
                                {ordinal(day)} - <a href={`/${post.id}/`}>{post.data.title}</a>
                              </li>
                            );
                          })
                        }
                      </ul>
                    </div>
                  ))
              }
            </section>
          ))
      }
    </main>
    <Footer />
  </body>
</html>
